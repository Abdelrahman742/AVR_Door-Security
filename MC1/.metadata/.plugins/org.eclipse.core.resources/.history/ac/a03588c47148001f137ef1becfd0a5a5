/*
 * Main.c
 *
 *  Created on: Jul 6, 2024
 *      Author: dell
*/
#include<avr/io.h>
#include "lcd.h"
#include "keypad.h"
#include "uart.h"
#include <util/delay.h>
#include "timer1.h"

#define GET_READY 			0x10
#define GET_READY2 			0x20
#define GET_READY3 			0x30
#define GET_READY4 			0x40
#define GET_READY5 			0x50
#define GET_READY6 			0x60

uint8 password_1[5]={0};
uint8 password_2[5]={0};
uint8 Entered_pass[5]={0};
uint8 flag=0;
volatile uint8 STEP1 = 1;
volatile uint8 STEP2 = 0;
uint8 counter=0;

/*void Timer1_delay(uint32 mili_seconds)
{
	uint32 Cycles=mili_seconds*8;
	uint32 i;
	for(i=0;i<Cycles;i++);
}*/

void Enter_Password(uint8 password[])
{
	uint8 i;
	for(i=0;i<10;i++)
	{
		password[i]= KEYPAD_getPressedKey();
		if(KEYPAD_getPressedKey() == '=') /* 13 Button means Enter */
		{
			break;
		}
		else
		{
			LCD_displayCharacter('*');
			_delay_ms(500);
		}
	}
}

void sendPasswordByUART(uint8 *PASSWORD)
{
	uint8 i;
	for(i=0;i<5;i++) /* Sending Password */
	{
		UART_sendByte(PASSWORD[i]);
		/*_delay_ms(10);*/
	}
}

void Step_3_4(void)
{
	LCD_moveCursor(0,0);
	LCD_displayString("+ : Open Door");
	LCD_moveCursor(1,0);
	LCD_displayString("- : Change Pass");
	_delay_ms(500);
	if(KEYPAD_getPressedKey() == '+')
	{
		LCD_clearScreen();
		Enter_Password(Entered_pass);
		UART_sendByte(GET_READY5);
		sendPasswordByUART(Entered_pass);
		LCD_displayString("Door is Unlocking");
		_delay_ms(15000);
		LCD_displayString("Door is Locking");
	}
	else if(KEYPAD_getPressedKey() == '-')
	{
		LCD_clearScreen();
		Enter_Password(Entered_pass);
		UART_sendByte(GET_READY6);
		if(UART_recieveByte() == '3')
		{
			flag=1;
		}
		else if(UART_recieveByte() == '4')
		{
			flag=0;
		}
	}
}

int main()
{
	Timer1_ConfigType Timer1_Configurations={0,0,clk_1,Normal};
	UART_ConfigType UART_Configurations = {BITS8,EVEN_PARITY,STOP_1BIT,BDR6};
	SREG |= (1<<7);
	LCD_init();
	UART_init(&UART_Configurations);
	Timer1_init(&Timer1_Configurations);

	while(1)
	{
		LCD_clearScreen();

		if(STEP1 == 1)
		{
			LCD_displayString("plz enter pass:");
			LCD_moveCursor(1,0);
			Enter_Password(password_1);

			LCD_clearScreen();
			LCD_displayStringRowColumn(0,0,"plz re-enter the");
			LCD_displayStringRowColumn(1,0,"same pass:");
			_delay_ms(500);
			LCD_moveCursor(1,10);
			for(counter=0;counter<10;counter++)
			{
				password_2[counter]=KEYPAD_getPressedKey();
				if(KEYPAD_getPressedKey() == '=') /* 13 Button means Enter */
				{
					break;
				}
				else
				{
					LCD_displayCharacter('*');
					_delay_ms(500);
				}
			}

			UART_sendByte(GET_READY);
			sendPasswordByUART(password_1);
			sendPasswordByUART(password_2);

			if(UART_recieveByte() == '#')
			{
				STEP2=1;
				STEP1=0;
			}
		}

		if(STEP2 == 1)
		{
			Step_3_4();
			UART_sendByte(GET_READY2);
			if(flag==1)
			{
				break;
			}
			else if(flag==0)
			{
				Enter_Password(Entered_pass);
				UART_sendByte(GET_READY3);
				if(UART_recieveByte() == '5')
				{
					Step_3_4();
				}
				else if(UART_recieveByte() == '6')
				{
					Enter_Password(Entered_pass);
					UART_sendByte(GET_READY4);
					if(UART_recieveByte() == '7')
					{
						Step_3_4();
					}
					else if(UART_recieveByte() == '8')
					{
						UART_sendByte(9);
						LCD_displayString("ERROR");
						_delay_ms(60000);
					}
				}
			}
		}
	}
}
